<!DOCTYPE html>
<html lang="th" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart-TAG System</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Sarabun"', '"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: { 
                        primary: { 50: '#f0f7ff', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        slate: { 850: '#1e293b', 950: '#0f172a' } 
                    }
                }
            }
        }
    </script>
    <style>
        /* --- Dark Mode Enhancements (Softer Tone) --- */
        :root { 
            --dark-bg: #111827;      /* Gray 900 - Softer than pure black */
            --dark-card: #1f2937;    /* Gray 800 */
            --dark-border: #374151;  /* Gray 700 */
            --dark-text-muted: #9ca3af; 
        }
        
        .dark body { 
            background-color: var(--dark-bg); 
            background-image: radial-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px); 
            background-size: 24px 24px; 
            color: #f3f4f6; 
        }
        
        .dark .glass-card { 
            background: rgba(31, 41, 55, 0.7); /* Matching Gray 800 with opacity */
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }
        
        /* Softer input backgrounds in dark mode */
        .dark input, .dark textarea, .dark select { 
            background-color: rgba(17, 24, 39, 0.6) !important; 
            border-color: var(--dark-border) !important; 
            color: #f9fafb !important; 
        }
        
        .dark input::placeholder, .dark textarea::placeholder {
            color: #6b7280;
        }

        /* Table adjustments for dark mode */
        .dark table thead {
            background-color: rgba(31, 41, 55, 0.95) !important;
            color: #d1d5db !important;
        }
        
        .dark table tbody tr:hover {
            background-color: rgba(55, 65, 81, 0.4) !important;
        }
        
        .dark .tag-pin { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        .img-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 2px dashed #cbd5e1; display: none; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); color: white; flex-direction: column; }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes pulse-danger { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        .tag-pin.animate-pulse { animation: pulse-red 2s infinite; }
        .tag-pin.danger-tech-pulse { animation: pulse-danger 2s infinite; }

        .pin-number { position: absolute; top: -8px; right: -8px; background: white; color: #0f172a; font-size: 10px; font-weight: 800; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 2px solid currentColor; }
        .mode-btn { transition: all 0.2s; opacity: 0.6; border: 2px solid transparent; }
        .mode-btn:hover { opacity: 1; }
        .mode-active { opacity: 1 !important; transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); font-weight: 800 !important; }
        .mode-active.white { border-color: #94a3b8; background-color: #f1f5f9; color: #0f172a; }
        .mode-active.red { border-color: #ef4444; background-color: #fef2f2; color: #b91c1c; }
        
        

        .carousel-btn { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); border: 2px solid rgba(255, 255, 255, 0.2); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; position: absolute; top: 50%; transform: translateY(-50%); z-index: 20; }
        .carousel-btn:hover { background: rgba(59, 130, 246, 0.8); border-color: rgba(255, 255, 255, 0.4); transform: translateY(-50%) scale(1.1); }
        .carousel-btn.left { left: 10px; }
        .carousel-btn.right { right: 10px; }
        /* ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô‡∏†‡∏≤‡∏û */
        .rotate-btn { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px); border: 2px solid rgba(255, 255, 255, 0.2); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; position: absolute; bottom: 10px; right: 10px; z-index: 20; }
        .rotate-btn:hover { background: rgba(59, 130, 246, 0.8); border-color: rgba(255, 255, 255, 0.4); transform: scale(1.1); }
        
        .img-preview { transition: transform 0.3s ease; }

        
        /* ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏á‡∏ó‡∏µ‡πà */
        #target-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
        }
        
        #img-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }
        /* Mobile optimizations */
        @media (max-width: 768px) {
            #img-wrapper {
                min-height: 250px !important;
                max-height: 350px !important;
            }
            
            #target-image {
                width: 100% !important;
                height: 100% !important;
                object-fit: contain !important;
            }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö main content ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            main {
                padding: 0.75rem !important;
                overflow-y: auto !important;
            }
            
            /* ‡∏•‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà header ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            header {
                padding: 0.5rem 0.75rem !important;
            }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            #view-active table,
            #view-history table {
                font-size: 12px;
            }
            
            #view-active table td,
            #view-history table td {
                padding: 8px 6px !important;
            }
            
            #view-active table th,
            #view-history table th {
                padding: 8px 6px !important;
                font-size: 10px;
            }
            
            /* ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÑ‡∏î‡πâ */
            #view-active table td div,
            #view-history table td div {
                word-break: break-word;
                overflow-wrap: break-word;
            }
            
            /* ‡∏ã‡πà‡∏≠‡∏ô stat cards ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .grid.grid-cols-1.md\\:grid-cols-4 > div:not(:first-child) {
                display: none;
            }
        }
        
        /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏°‡∏≤‡∏Å */
        @media (max-width: 480px) {
            #img-wrapper {
                min-height: 200px !important;
                max-height: 300px !important;
            }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏≠‡∏µ‡∏Å */
            #view-active table,
            #view-history table {
                font-size: 11px;
            }
            
            #view-active table td,
            #view-history table td {
                padding: 6px 4px !important;
            }
        }
        
        /* Desktop - ‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏á‡∏ó‡∏µ‡πà */
        @media (min-width: 769px) {
            #target-image {
                width: 100% !important;
                height: 100% !important;
                object-fit: contain !important;
            }
        }

        @media print {
            @page { size: A4 landscape; margin: 0; }
            body * { visibility: hidden; }
            body { background: white; margin: 0; padding: 0; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: fixed; left: 0; top: 0; width: 297mm; height: 210mm; background: white; color: black; padding: 10mm; box-sizing: border-box; font-family: 'Sarabun', sans-serif; display: flex; flex-direction: column; justify-content: space-between; }
            .print-content-wrapper { flex-grow: 1; }
            .print-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: none; padding-bottom: 0; }
            .print-logo-img { height: 55px; object-fit: contain; } 
            .print-title { font-size: 24px; font-weight: bold; text-align: center; flex-grow: 1; }
            .print-table { width: 100%; border-collapse: collapse; font-size: 12px; }
            .print-table th, .print-table td { border: 1px solid black; padding: 4px 6px; vertical-align: middle; }
            .print-table td.top-align { vertical-align: top; height: 50px; }
            .print-img-box { height: 340px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #fff; }
            .print-img { max-width: 100%; max-height: 100%; object-fit: contain; }
            .print-label { font-weight: bold; font-size: 13px; }
            .dotted-line { border-bottom: 1px dotted #999; display: inline-block; width: 100%; height: 14px; }
            .print-footer-static { font-size: 10px; font-weight: bold; color: #333; text-align: left; margin-top: 5px; }
            button, select, #btn-admin-panel { display: none !important; }
        }
        #print-area { display: none; }
        @media print { #print-area { display: flex; } }
        
        .auth-bg { 
            background: #111827; 
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
        }
        #camera-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 20px;
}

#camera-modal.active {
    display: flex;
}

#camera-video {
    max-width: 100%;
    max-height: 70vh;
    background: #000;
    border-radius: 12px;
}

#camera-canvas {
    display: none;
    max-width: 90%;
    max-height: 65vh;
    object-fit: contain;
    background: #000;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}

.camera-controls {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    flex-wrap: wrap;
    justify-content: center;
    position: relative;
    z-index: 10000;
}

.camera-btn {
    padding: 16px 32px;
    border-radius: 50px;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    min-width: 140px;
}

.camera-btn.capture {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.camera-btn.capture:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: scale(1.08);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
}

.camera-btn.cancel {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.camera-btn.cancel:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
}

.camera-btn.retake {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.camera-btn.retake:hover {
    background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
}

.camera-btn.use {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.camera-btn.use:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    transform: scale(1.08);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
}
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 h-screen overflow-hidden flex flex-col">

    <div id="loading-screen" class="loading-overlay hidden">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-3 text-primary-500"></i>
        <div class="font-bold text-lg" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <!-- Auth Section -->
    <div id="auth-section" class="fixed inset-0 z-[100] bg-slate-50 flex items-center justify-center p-6 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:24px_24px]">
        <div class="w-full max-w-md">
            <div class="flex justify-center gap-8 mb-10">
                <img src="https://lh3.googleusercontent.com/d/1DjfZrqL3qge-MQLzDkG4BJowrN8m5U-b" class="h-16 drop-shadow-lg hover:scale-105 transition-transform duration-300">
                <img src="https://lh3.googleusercontent.com/d/16XUhPz_fOfLTmXc7MGqSRN7INbtl8E4r" class="h-16 drop-shadow-lg hover:scale-105 transition-transform duration-300">
            </div>

            <div id="login-form" class="bg-white rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.05)] p-10 border border-slate-100 relative overflow-hidden">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-extrabold tracking-tight text-slate-900">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
                    <p class="text-slate-400 text-sm mt-2 font-medium">Smart-TAG Management System</p>
                </div>

                <div class="space-y-4">
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">Username</label>
                        <div class="relative"><input type="text" id="login-username" oninput="validateInput(this)" class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-primary-500 outline-none transition-all placeholder-slate-300" placeholder="‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"></div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest px-1">Password</label>
                        <div class="relative"><input type="password" id="login-password" oninput="validateInput(this)" class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-primary-500 outline-none transition-all placeholder-slate-300" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                    </div>
                    <button onclick="handleLogin()" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-bold py-4 rounded-2xl shadow-xl shadow-primary-500/20 transition-all transform active:scale-[0.98] mt-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
                <div class="mt-8 text-center">
    <button onclick="switchAuth('register')" 
            class="text-primary-600 text-sm font-bold hover:underline underline-offset-4 mr-4">
        ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
    </button>
    <button onclick="switchAuth('forgot')" 
            class="text-orange-600 text-sm font-bold hover:underline underline-offset-4">
        ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?
    </button>
</div>
            </div>

            <div id="register-form" class="bg-white rounded-[2.5rem] shadow-2xl p-10 hidden border border-slate-100">
                <h2 class="text-2xl font-bold text-slate-900 mb-6">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                <div class="space-y-4">
                    <input type="text" id="reg-name" class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                    <input type="text" id="reg-username" oninput="validateInput(this)" class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Username (A-Z, 0-9)">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="password" id="reg-password" oninput="validateInput(this)" class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                        <input type="password" id="reg-confirm-password" oninput="validateInput(this)" class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô">
                    </div>
                    <button onclick="handleRegister()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-emerald-500/20 mt-4 transition-all transform active:scale-[0.98]">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                    <button onclick="switchAuth('login')" class="w-full text-slate-400 text-sm font-bold py-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
            <div id="forgot-password-form" class="bg-white rounded-[2.5rem] shadow-2xl p-10 hidden border border-slate-100">
    <h2 class="text-2xl font-bold text-slate-900 mb-6">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h2>
    <div class="space-y-4">
        <input type="text" id="forgot-username" 
               oninput="validateInput(this)"
               class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-orange-500 outline-none" 
               placeholder="Username">
        <input type="text" id="forgot-fullname" 
               class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-orange-500 outline-none" 
               placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)">
        <input type="password" id="forgot-new-password" 
               oninput="validateInput(this)"
               class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-orange-500 outline-none" 
               placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
        <input type="password" id="forgot-confirm-password" 
               oninput="validateInput(this)"
               class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-orange-500 outline-none" 
               placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
        <button onclick="handleForgotPassword()" 
                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-orange-500/20 mt-4 transition-all transform active:scale-[0.98]">
            ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        </button>
        <button onclick="switchAuth('login')" 
                class="w-full text-slate-400 text-sm font-bold py-2">
            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
    </div>
</div>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="flex flex-col h-full hidden">
        <header class="h-16 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 z-10 shrink-0">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <div class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary-600 to-violet-600 dark:from-cyan-400 dark:to-teal-400 cursor-default">
                        <i class="fa-solid fa-tags mr-2"></i>Smart-TAG
                    </div>
                    <div class="flex items-center gap-2 ml-4">
                        <i class="fa-solid fa-server text-slate-400 text-xs"></i>
                        <select id="machineSelect" onchange="changeMachine()" class="text-sm bg-slate-100 dark:bg-slate-800 px-3 py-1.5 rounded-lg font-bold border-none outline-none focus:ring-2 focus:ring-primary-500"></select>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-sm font-bold text-slate-600 dark:text-slate-300 flex items-center gap-2">
                    <i class="fa-solid fa-user-circle"></i> 
                    <span id="user-display-name">Guest</span>
                    <span id="user-role-badge" class="px-2 py-0.5 text-[10px] rounded-full bg-slate-200 text-slate-600">User</span>
                </div>
                
                <button id="btn-admin-panel" onclick="openUserManagement()" class="text-xs bg-violet-100 text-violet-700 px-3 py-1 rounded hover:bg-violet-200 hidden font-bold">
                    <i class="fa-solid fa-users-gear mr-1"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                </button>
                
                <button onclick="openAssetManager()" id="btn-asset-panel" class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded hover:bg-purple-200 hidden font-bold">
                    <i class="fa-solid fa-gear mr-1"></i>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£
                </button>

                <button onclick="logout()" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded hover:bg-red-200">Logout</button>
                <div id="sync-status" class="text-xs font-bold text-slate-400 hidden"><i class="fa-solid fa-cloud-arrow-up animate-bounce"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...</div>
                
                <button onclick="openHelpModal()" class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/30 dark:text-blue-400 flex items-center justify-center text-sm transition-all"><i class="fa-solid fa-circle-question"></i></button>
                <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 rounded-full border border-slate-200 dark:border-slate-700">
                    <button onclick="toggleTheme('light')" class="w-8 h-8 rounded-full flex items-center justify-center text-xs transition-all duration-300" id="btn-light"><i class="fa-solid fa-sun"></i></button>
                    <button onclick="toggleTheme('dark')" class="w-8 h-8 rounded-full flex items-center justify-center text-xs transition-all duration-300" id="btn-dark"><i class="fa-solid fa-moon"></i></button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-auto p-4 md:p-6 space-y-6 w-full max-w-[1920px] mx-auto">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-extrabold text-slate-900 dark:text-white" id="asset-name-display">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h2>
                    <p class="text-sm text-slate-400 mt-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡πá‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openChartModal()" class="px-4 py-2.5 bg-gradient-to-r from-cyan-500 to-blue-600 text-white rounded-xl hover:shadow-lg transition-all font-bold text-sm"><i class="fa-solid fa-chart-line mr-2"></i>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥/‡∏Å‡∏£‡∏≤‡∏ü</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div onclick="openChartModal()" class="cursor-pointer bg-gradient-to-br from-primary-600 to-violet-600 rounded-2xl p-4 text-white shadow-lg relative overflow-hidden card-hover group ring-offset-2 ring-offset-slate-50 dark:ring-offset-slate-900 hover:ring-2 hover:ring-primary-500 transition-all">
                    <div class="absolute right-0 top-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl group-hover:bg-white/20 transition-all"></div>
                    <div class="relative z-10 flex flex-col h-full justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-2"><div class="text-xs font-bold uppercase tracking-wider">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°</div><i class="fa-solid fa-chart-pie text-white/50 group-hover:text-white"></i></div>
                            <div class="flex items-baseline gap-2"><div class="text-4xl font-extrabold font-['Plus_Jakarta_Sans']" id="stat-total-percent">0%</div><div class="text-xs opacity-80">‡∏£‡∏ß‡∏° <span id="stat-total-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
                        </div>
                        <div class="mt-3 grid grid-cols-3 gap-2 border-t border-white/20 pt-3 text-center">
                            <div><div class="text-[10px] opacity-70 mb-1">‚ö™ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div><div class="font-bold text-sm" id="sub-stat-white">0%</div></div>
                            <div class="border-l border-white/10"><div class="text-[10px] opacity-70 mb-1">üî¥ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</div><div class="font-bold text-sm" id="sub-stat-red">0%</div></div>
                            <div class="border-l border-white/10"><div class="text-[10px] opacity-70 mb-1">üü° ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</div><div class="font-bold text-sm" id="sub-stat-yellow">0%</div></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-between">
                    <div class="text-slate-400 text-xs font-bold uppercase">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
                    <div class="flex justify-between items-end"><div class="text-2xl font-bold" id="stat-white-percent">0%</div><div class="text-xs text-slate-500" id="stat-white-count">0/0</div></div>
                    <div class="w-full bg-slate-100 dark:bg-slate-700 rounded-full h-1.5 mt-2"><div class="bg-slate-500 h-1.5 rounded-full" id="bar-white" style="width: 0%"></div></div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-between">
                    <div class="text-slate-400 text-xs font-bold uppercase">‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</div>
                    <div class="flex justify-between items-end"><div class="text-2xl font-bold" id="stat-red-percent">0%</div><div class="text-xs text-slate-500" id="stat-red-count">0/0</div></div>
                    <div class="w-full bg-red-50 dark:bg-slate-700 rounded-full h-1.5 mt-2"><div class="bg-red-500 h-1.5 rounded-full" id="bar-red" style="width: 0%"></div></div>
                </div>
                <div class="bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-100 dark:border-slate-700 shadow-sm flex flex-col justify-between">
                    <div class="text-slate-400 text-xs font-bold uppercase">‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</div>
                    <div class="flex justify-between items-end"><div class="text-2xl font-bold" id="stat-yellow-percent">0%</div><div class="text-xs text-slate-500" id="stat-yellow-count">0/0</div></div>
                    <div class="w-full bg-yellow-50 dark:bg-slate-700 rounded-full h-1.5 mt-2"><div class="bg-yellow-500 h-1.5 rounded-full" id="bar-yellow" style="width: 0%"></div></div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 xl:h-[calc(100vh-280px)] xl:min-h-[500px]">
                <div class="xl:col-span-2 flex flex-col gap-3">
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î TAG ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ - ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏£‡∏π‡∏õ -->
                    <div class="md:hidden bg-white/95 dark:bg-slate-800/95 backdrop-blur-xl rounded-2xl p-2.5 shadow-lg border border-slate-200 dark:border-slate-700">
                        <div class="text-[9px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1.5 text-center">‡πÇ‡∏´‡∏°‡∏î TAG:</div>
                        <div class="grid grid-cols-2 gap-1.5">
                            <button class="px-2 py-1.5 rounded-lg text-[10px] font-bold border transition-all shadow-sm bg-white dark:bg-slate-700" onclick="setMode('white')" id="btn-mode-white-mobile">‚ö™ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
                            <button class="px-2 py-1.5 rounded-lg text-[10px] font-bold border transition-all shadow-sm bg-white dark:bg-slate-700" onclick="setMode('red')" id="btn-mode-red-mobile">üî¥ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</button>
                            </div>
                    </div>
                    
                    <div class="flex-1 xl:flex-1 min-h-[300px] max-h-[400px] xl:max-h-none bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col relative overflow-hidden">
                        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î TAG ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Desktop - ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
                        <div class="hidden md:flex p-3 border-b border-slate-100 dark:border-slate-700 flex-wrap gap-2 items-center bg-slate-50/50 dark:bg-slate-800/50">
                            <span class="text-xs font-bold text-slate-400 uppercase mr-1">‡πÇ‡∏´‡∏°‡∏î Tag:</span>
                            <button class="px-3 py-1.5 rounded-lg text-xs font-bold border transition-all" onclick="setMode('white')" id="btn-mode-white">‚ö™ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</button>
                            <button class="px-3 py-1.5 rounded-lg text-xs font-bold border transition-all" onclick="setMode('red')" id="btn-mode-red">üî¥ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</button>
                            </div>
                        
                        <div class="flex-1 relative bg-slate-100 dark:bg-black overflow-hidden flex items-center justify-center cursor-crosshair" id="img-wrapper">
                            <img id="target-image" src="" class="w-full h-full object-contain relative z-0 shadow-2xl">
                            <div id="pins-layer" class="absolute inset-0 z-10 w-full h-full pointer-events-none"></div>
                        </div>
                    </div>
                    
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ - ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏£‡∏π‡∏õ -->
                    <div class="md:hidden bg-white/95 dark:bg-slate-900/95 backdrop-blur-md rounded-full border border-slate-200 dark:border-slate-700 shadow-lg flex items-center justify-center gap-3 py-2.5">
                        <button onclick="changeImage(-1)" class="w-10 h-10 flex items-center justify-center hover:scale-110 transition-transform"><i class="fa-solid fa-chevron-left text-lg"></i></button>
                        <span id="page-indicator-mobile" class="text-xs font-bold text-slate-600 dark:text-slate-300 min-w-[80px] text-center">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1 / 1</span>
                        <button onclick="changeImage(1)" class="w-10 h-10 flex items-center justify-center hover:scale-110 transition-transform"><i class="fa-solid fa-chevron-right text-lg"></i></button>
                    </div>
                    
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Desktop - ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ -->
                    <div class="hidden md:flex absolute bottom-4 right-4 items-center gap-4 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md px-4 py-2 rounded-full border border-slate-200 dark:border-slate-700 shadow-lg z-20">
                        <button onclick="changeImage(-1)" class="hover:scale-110 transition-transform"><i class="fa-solid fa-chevron-left"></i></button>
                        <span id="page-indicator" class="text-xs font-bold text-slate-600 dark:text-slate-300 min-w-[80px] text-center">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà 1 / 1</span>
                        <button onclick="changeImage(1)" class="hover:scale-110 transition-transform"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm flex flex-col overflow-hidden min-h-[300px] xl:h-full">
                    <div class="flex border-b border-slate-100 dark:border-slate-700 shrink-0">
                        <button class="flex-1 py-3 text-sm font-bold text-primary-600 dark:text-cyan-400 border-b-2 border-primary-600 dark:border-cyan-400 bg-primary-50 dark:bg-slate-800/50" onclick="switchTab('active')" id="tab-active">TAG ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏°</button>
                        <button class="flex-1 py-3 text-sm font-bold text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700/50" onclick="switchTab('history')" id="tab-history">TAG ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß</button>
                    </div>
                    <div id="filter-controls" class="p-2 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/30">
                        <span class="text-[10px] uppercase font-bold text-slate-400 ml-2">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏µ (Filter):</span>
                        <select id="filter-color" onchange="applyFilter()" class="text-xs border border-slate-200 dark:border-slate-600 rounded-lg p-1.5 bg-white dark:bg-slate-700 dark:text-white outline-none focus:ring-2 focus:ring-primary-500">
                            <option value="all">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="white">‚ö™ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                            <option value="red">üî¥ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</option>
                            </select>
                    </div>
                    <div id="view-active" class="flex-1 overflow-y-auto p-0">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-900/50 text-slate-500 text-xs uppercase sticky top-0 z-10 backdrop-blur-sm shadow-sm">
                                <tr><th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™/‡∏†‡∏≤‡∏û</th><th class="px-4 py-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th class="px-4 py-3 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                            </thead>
                            <tbody id="tbody-active" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                        <div id="empty-active" class="text-center py-10 text-slate-400 text-sm italic hidden">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    </div>
                    <div id="view-history" class="flex-1 overflow-y-auto p-0 hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 dark:bg-slate-900/50 text-slate-500 text-xs uppercase sticky top-0 z-10 shadow-sm">
                                <tr><th class="px-4 py-3">‡∏õ‡∏±‡∏ç‡∏´‡∏≤</th><th class="px-4 py-3">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th><th class="px-4 py-3 text-right">‡∏î‡∏π‡∏ú‡∏•‡∏á‡∏≤‡∏ô</th></tr>
                            </thead>
                            <tbody id="tbody-history" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                        <div id="empty-history" class="text-center py-10 text-slate-400 text-sm italic hidden">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Print Area -->
    <div id="print-area">
        <div class="print-content-wrapper">
            <div class="print-header">
                <img src="https://lh3.googleusercontent.com/d/1DjfZrqL3qge-MQLzDkG4BJowrN8m5U-b" class="print-logo-img" alt="Logo Left">
                <div class="print-title" id="print-title">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</div>
                <img src="https://lh3.googleusercontent.com/d/16XUhPz_fOfLTmXc7MGqSRN7INbtl8E4r" class="print-logo-img" alt="Logo Right">
            </div>
            
            <div class="print-group-section" style="margin-bottom:10px; font-weight:bold;">
                ‡∏Å‡∏•‡∏∏‡πà‡∏° : <span id="print-group-name">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î Laser SENFENG - SF3015HM</span>
            </div>

            <table class="print-table">
                <tr>
                    <td colspan="2" width="50%"><span class="print-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ :</span> <span id="print-machine-name"></span></td>
                    <td width="25%"><span class="print-label">‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ :</span> <span id="print-machine-id"></span></td>
                    <td width="25%"><span class="print-label">‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á :</span> <span id="print-ref"></span></td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align:center; font-weight:bold; background:#eee;">‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (Before)</td>
                    <td colspan="2" style="text-align:center; font-weight:bold; background:#eee;">‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (After)</td>
                </tr>
                <tr>
                    <td colspan="2" style="text-align:center; padding:0;">
                        <div class="print-img-box">
                            <img id="print-img-before" class="print-img" src="">
                            <div id="print-no-before" style="display:none; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
                        </div>
                    </td>
                    <td colspan="2" style="text-align:center; padding:0;">
                        <div class="print-img-box">
                            <img id="print-img-after" class="print-img" src="">
                            <div id="print-no-after" style="display:none; color:#999;">(‡∏£‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)</div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" class="top-align">
                        <div class="print-label">‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö :</div>
                        <div id="print-problem" style="margin-top:5px; margin-bottom:15px; min-height:40px;"></div>
                        <div class="dotted-line"></div>
                        <div class="dotted-line"></div>
                    </td>
                    <td colspan="2" class="top-align">
                        <div class="print-label">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç :</div>
                        <div id="print-solution" style="margin-top:5px; margin-bottom:15px; min-height:40px;"></div>
                        <div class="dotted-line"></div>
                        <div class="dotted-line"></div>
                    </td>
                </tr>
                <tr>
                    <td colspan="4">
                        <span class="print-label">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö :</span> <span id="print-loc"></span>
                    </td>
                </tr>
                <tr>
                    <td><span class="print-label">‡∏ú‡∏π‡πâ‡∏û‡∏ö :</span> <span id="print-finder"></span></td>
                    <td><span class="print-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö :</span> <span id="print-date-found"></span></td>
                    <td><span class="print-label">‡∏ú‡∏π‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç :</span> <span id="print-fixer"></span></td>
                    <td><span class="print-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à :</span> <span id="print-date-fixed"></span></td>
                </tr>
            </table>
        </div>
        <div class="print-footer-static" id="print-footer-code">TPM-xxx</div>
    </div>

    <!-- Modals -->
    <div id="modal-users" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-2xl p-6 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-slate-700">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white"><i class="fa-solid fa-users-gear mr-2 text-violet-500"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>
                <button onclick="closeModal('modal-users')" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-1 overflow-auto">
                <table class="w-full text-left text-sm border-collapse">
                    <thead class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold sticky top-0 z-10">
                        <tr><th class="p-3 border-b dark:border-slate-700">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th class="p-3 border-b dark:border-slate-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="p-3 border-b dark:border-slate-700">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Role)</th></tr>
                    </thead>
                    <tbody id="user-list-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-add" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 border-b pb-2 dark:border-slate-700 dark:text-white">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
            <div class="space-y-3">
                <div>
    <label class="text-xs font-bold text-slate-500 block mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Before)</label>
    <div class="flex gap-2">
        <input type="file" id="add-image" accept="image/*" class="flex-1 text-xs">
        <button type="button" onclick="openCamera('add-image')" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-xs hover:bg-blue-600 whitespace-nowrap">
            <i class="fa-solid fa-camera mr-1"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
        </button>
    </div>
    <div class="relative inline-block">
        <img id="preview-add" class="img-preview mt-2">
        <div class="rotate-btn" onclick="rotateImage('preview-add')" style="display:none;" id="rotate-preview-add">
            <i class="fa-solid fa-rotate-right"></i>
        </div>
    </div>
</div>
                <input type="text" id="add-reporter" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á" readonly>
                <input type="text" id="add-loc" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">
                <textarea id="add-desc" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤"></textarea>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('modal-add')" class="px-4 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveTag()" class="px-4 py-2 rounded-lg text-sm bg-primary-600 text-white hover:bg-primary-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="modal-edit" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 border-b pb-2 dark:border-slate-700 dark:text-white">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <input type="hidden" id="edit-old-id">
            <div class="space-y-3">
                <div><label class="text-xs font-bold text-slate-500">‡∏£‡∏´‡∏±‡∏™ ID</label><input type="text" id="edit-id" class="w-full border rounded-lg px-3 py-2 text-sm font-bold bg-slate-50 dark:bg-slate-800 dark:text-white"></div>
                <div><label class="text-xs font-bold text-slate-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="edit-type" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white"><option value="white">‚ö™ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option><option value="red">üî¥ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</option></select></div>
                <input type="text" id="edit-reporter" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á">
                <div id="admin-date-fields" style="display:none;">
    <div>
        <label class="text-xs font-bold text-slate-500">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á (‡πÄ‡∏ä‡πà‡∏ô 28/01/2569 14:30)</label>
        <input type="text" id="edit-report-time" 
               class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" 
               placeholder="dd/mm/yyyy HH:MM">
        <p class="text-[10px] text-slate-400 mt-1">üí° Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ</p>
    </div>
    <div>
        <label class="text-xs font-bold text-slate-500">‚úÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
        <input type="text" id="edit-fix-time" 
               class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" 
               placeholder="dd/mm/yyyy HH:MM">
        <p class="text-[10px] text-slate-400 mt-1">üí° ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</p>
    </div>
</div>
                <input type="text" id="edit-loc" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå">
                <textarea id="edit-desc" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤"></textarea>
                <div>
    <label class="text-xs font-bold text-slate-500 block mb-1">‡∏£‡∏π‡∏õ Before (‡∏õ‡∏±‡∏ç‡∏´‡∏≤)</label>
    <div class="flex gap-2">
        <input type="file" id="edit-image" accept="image/*" class="flex-1 text-xs">
        <button type="button" onclick="openCamera('edit-image')" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-xs hover:bg-blue-600 whitespace-nowrap">
            <i class="fa-solid fa-camera mr-1"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
        </button>
    </div>
    <div class="relative inline-block">
        <img id="preview-edit" class="img-preview mt-2">
        <div class="rotate-btn" onclick="rotateImage('preview-edit')" style="display:none;" id="rotate-preview-edit">
            <i class="fa-solid fa-rotate-right"></i>
        </div>
    </div>
</div>
                <div>
    <label class="text-xs font-bold text-slate-500 block mb-1">‡∏£‡∏π‡∏õ After (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß)</label>
    <div class="flex gap-2">
        <input type="file" id="edit-image-after" accept="image/*" class="flex-1 text-xs">
        <button type="button" onclick="openCamera('edit-image-after')" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-xs hover:bg-blue-600 whitespace-nowrap">
            <i class="fa-solid fa-camera mr-1"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
        </button>
    </div>
    <div class="relative inline-block">
        <img id="preview-edit-after" class="img-preview mt-2" style="display:none;">
        <div class="rotate-btn" onclick="rotateImage('preview-edit-after')" style="display:none;" id="rotate-preview-edit-after">
            <i class="fa-solid fa-rotate-right"></i>
        </div>
    </div>
</div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('modal-edit')" class="px-4 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveEdit()" class="px-4 py-2 rounded-lg text-sm bg-orange-500 text-white hover:bg-orange-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
        </div>
    </div>

    <div id="modal-fix" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 border-b pb-2 dark:border-slate-700 dark:text-white">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h3>
            <input type="hidden" id="fix-tag-id">
            <div class="space-y-3">
                <div class="mb-4 text-center">
                    <span class="text-xs font-bold text-slate-500 block mb-1 text-left">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Before)</span>
                    <img id="fix-preview-before" class="w-full h-40 object-contain bg-slate-100 dark:bg-slate-800 rounded border border-dashed border-slate-300 dark:border-slate-600" src="">
                </div>
                <div>
    <label class="block text-xs font-bold text-slate-500 mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (After)</label>
    <div class="flex gap-2">
        <input type="file" id="fix-image" accept="image/*" class="flex-1 text-xs">
        <button type="button" onclick="openCamera('fix-image')" class="px-3 py-1 bg-blue-500 text-white rounded-lg text-xs hover:bg-blue-600 whitespace-nowrap">
            <i class="fa-solid fa-camera mr-1"></i>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
        </button>
    </div>
    <div class="relative inline-block">
        <img id="preview-fix" class="img-preview mt-2">
        <div class="rotate-btn" onclick="rotateImage('preview-fix')" style="display:none;" id="rotate-preview-fix">
            <i class="fa-solid fa-rotate-right"></i>
        </div>
    </div>
</div>
                <input type="text" id="fix-resolver" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡πà‡∏≠‡∏°" readonly>
                <textarea id="fix-resolution" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"></textarea>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('modal-fix')" class="px-4 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="submitFix()" class="px-4 py-2 rounded-lg text-sm bg-emerald-600 text-white hover:bg-emerald-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="modal-compare" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col relative overflow-hidden">
            <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
                <div>
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-code-compare text-primary-500"></i> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h3>
                    <p class="text-sm text-slate-500" id="compare-tag-id">...</p>
                </div>
                <div class="flex items-center gap-3" id="modal-nav-controls">
                    <button onclick="switchCompareResult(-1)" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="compare-counter" class="text-sm font-bold text-slate-500">1 / 1</span>
                    <button onclick="switchCompareResult(1)" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 flex items-center justify-center transition-colors"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="flex gap-2">
                    <button onclick="printForm()" class="px-3 py-1 bg-slate-200 hover:bg-slate-300 rounded text-slate-700 text-sm font-bold flex items-center gap-2"><i class="fa-solid fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå PDF</button>
                    <button onclick="closeModal('modal-compare')" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-100 dark:bg-black/20">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                    <div class="flex flex-col gap-3">
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-red-100 dark:border-red-900/30">
                            <span class="inline-block px-3 py-1 rounded-full bg-red-100 text-red-600 text-xs font-bold mb-2">BEFORE</span>
                            <div class="aspect-video bg-slate-200 dark:bg-slate-900 rounded-lg overflow-hidden flex items-center justify-center"><img id="compare-img-before" class="w-full h-full object-contain hidden"><span id="no-img-before" class="text-slate-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span></div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-2 text-sm">
                            <p><span class="text-slate-400">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span> <span id="compare-report-time" class="dark:text-white"></span></p>
                            <p><span class="text-slate-400">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</span> <span id="compare-reporter" class="dark:text-white"></span></p>
                            <p class="mt-2 bg-red-50 dark:bg-red-900/20 p-3 rounded-lg text-red-700 dark:text-red-300 italic" id="compare-desc"></p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-3">
                        <div class="bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-emerald-100 dark:border-emerald-900/30">
                            <span class="inline-block px-3 py-1 rounded-full bg-emerald-100 text-emerald-600 text-xs font-bold mb-2">AFTER</span>
                            <div class="aspect-video bg-slate-200 dark:bg-slate-900 rounded-lg overflow-hidden flex items-center justify-center">
                                <img id="compare-img-after" class="w-full h-full object-contain hidden">
                                <span id="no-img-after" class="text-slate-400 text-sm text-center"></span>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm space-y-2 text-sm">
                            <p><span class="text-slate-400">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span> <span id="compare-fix-time" class="dark:text-white"></span></p>
                            <p><span class="text-slate-400">‡∏ú‡∏π‡πâ‡∏ã‡πà‡∏≠‡∏°:</span> <span id="compare-resolver" class="dark:text-white"></span></p>
                            <p class="mt-2 bg-emerald-50 dark:bg-emerald-900/20 p-3 rounded-lg text-emerald-700 dark:text-emerald-300 italic" id="compare-resolution"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-chart" class="fixed inset-0 bg-black/70 backdrop-blur-md z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-4xl p-6 relative border border-slate-200 dark:border-slate-700 flex flex-col">
            <button onclick="closeModal('modal-chart')" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            <div class="flex justify-between items-end mb-4 border-b border-slate-100 pb-4">
                <div><h3 class="text-xl font-bold text-slate-800 dark:text-white">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</h3></div>
                <div class="flex gap-2">
                    <select id="chart-type-filter" onchange="initChart()" class="text-sm border rounded-lg px-3 py-2 bg-slate-50 dark:bg-slate-800 dark:text-white outline-none">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="white">‚ö™ ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                        <option value="red">üî¥ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</option>
                        </select>
                    <select id="chart-year" onchange="initChart()" class="text-sm border rounded-lg px-3 py-2 bg-slate-50 dark:bg-slate-800 dark:text-white outline-none"></select>
                </div>
            </div>
            <!-- FIX: Explicit Height -->
            <div class="w-full" style="height: 400px;" id="chart-container"></div>
        </div>
    </div>

    <div id="modal-asset-manager" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4 dark:text-white">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</h3>
            <div class="space-y-3">
                <input type="text" id="manage-asset-id" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô MC-01)">
                <input type="text" id="manage-asset-name" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">
                <div>
                    <label class="text-xs font-bold text-slate-500 block mb-1">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà:</label>
                    <input type="file" id="asset-upload-images" accept="image/*" multiple class="w-full text-xs">
                </div>
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-3">
                    <div class="text-xs font-bold text-yellow-800 dark:text-yellow-400 mb-2">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö)</div>
                    <input type="text" id="delete-image-indices" class="w-full border rounded-lg px-3 py-2 text-sm dark:bg-slate-800 dark:text-white" placeholder="‡πÄ‡∏ä‡πà‡∏ô: 0, 2 (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà 0)">
                    <button onclick="deleteSelectedImages()" class="mt-2 px-3 py-1.5 bg-red-600 text-white rounded-lg text-xs hover:bg-red-700"><i class="fa-solid fa-trash mr-1"></i>‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('modal-asset-manager')" class="px-4 py-2 rounded-lg text-sm bg-slate-100 hover:bg-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveAssetConfig()" class="px-4 py-2 rounded-lg text-sm bg-purple-600 text-white hover:bg-purple-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="modal-help" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-y-auto p-6 relative">
            <button onclick="closeModal('modal-help')" class="absolute top-4 right-4 w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-bold mb-4 text-primary-600 dark:text-primary-400 border-b pb-2"><i class="fa-solid fa-book-open mr-2"></i>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
            <div class="space-y-6 text-slate-700 dark:text-slate-300 text-sm">
                <div>
                    <h4 class="font-bold text-base mb-2 flex items-center"><span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mr-2 text-xs">1</span> ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Tag (‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤)</h4>
                    <ul class="list-disc pl-10 space-y-1">
                        <li>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <strong>"‡πÇ‡∏´‡∏°‡∏î Tag"</strong> (‡∏™‡∏µ‡∏Ç‡∏≠‡∏á Tag) ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</li>
                        <li><strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</strong> ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</li>
                        <li>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏Å‡∏î <strong>"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"</strong></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-base mb-2 flex items-center"><span class="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center mr-2 text-xs">2</span> ‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (Fix)</h4>
                    <ul class="list-disc pl-10 space-y-1">
                        <li>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà <strong>‡∏´‡∏°‡∏∏‡∏î (Pin)</strong> ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏° <strong>"‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô"</strong> ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á</li>
                        <li>‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û <strong>Before</strong> (‡∏õ‡∏±‡∏ç‡∏´‡∏≤) ‡πÉ‡∏´‡πâ‡∏î‡∏π</li>
                        <li>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (After) ‡∏°‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡∏∞‡∏Å‡∏î <strong>"‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô"</strong></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-base mb-2 flex items-center"><span class="w-6 h-6 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center mr-2 text-xs">3</span> ‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (PDF)</h4>
                    <ul class="list-disc pl-10 space-y-1">
                        <li>‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö <strong>"TAG ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß"</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong>"‡∏î‡∏π‡∏ú‡∏•‡∏á‡∏≤‡∏ô"</strong></li>
                        <li>‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong><i class="fa-solid fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå PDF</strong></li>
                        <li>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏•‡∏π‡∏Å‡∏®‡∏£ <strong>< ></strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- Camera Modal -->
<div id="camera-modal">
    <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
    <div id="camera-status" style="position: absolute; top: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 50px; font-weight: bold; z-index: 10001; backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
        <i class="fa-solid fa-camera mr-2"></i>
        <span id="camera-status-text">‡∏à‡∏±‡∏î‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</span>
    </div>
    
    <video id="camera-video" autoplay playsinline></video>
    <canvas id="camera-canvas"></canvas>
    
    <div class="camera-controls">
        <button class="camera-btn capture" id="btn-capture" onclick="capturePhoto()">
            <i class="fa-solid fa-camera"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
        </button>
        <button class="camera-btn retake" id="btn-retake" onclick="retakePhoto()" style="display:none;">
            <i class="fa-solid fa-rotate-right"></i> ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
        </button>
        <button class="camera-btn use" id="btn-use-photo" onclick="usePhoto()" style="display:none;">
            <i class="fa-solid fa-check"></i> ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ
        </button>
        <button class="camera-btn cancel" onclick="closeCameraModal()">
            <i class="fa-solid fa-xmark"></i> ‡∏õ‡∏¥‡∏î
        </button>
    </div>
</div>

    <script>
    // ==========================================
    // ‚öôÔ∏è SUPABASE CLIENT INIT
    // ==========================================
    const SUPABASE_URL = 'https://elyuuymovgqixoarvgov.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVseXV1eW1vdmdxaXhvYXJ2Z292Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzExMDQsImV4cCI6MjA4NjE0NzEwNH0.zXO90dqAAzZLOJjFRk7tgl-CqO1ExCA_Z_8Ts6UUK8M';
    const STORAGE_BUCKET = 'images';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function uploadImage(base64Data, fileName, folderName) {
        if (!base64Data || !base64Data.includes('base64,')) return '';
        try {
            const split = base64Data.split('base64,');
            const contentType = split[0].split(':')[1].split(';')[0];
            const raw = atob(split[1]);
            const arr = new Uint8Array(raw.length);
            for (let i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i);
            const blob = new Blob([arr], { type: contentType });
            const filePath = (folderName || 'misc') + '/' + fileName;
            const { error } = await sb.storage.from(STORAGE_BUCKET).upload(filePath, blob, { contentType, upsert: true });
            if (error) { console.error('Upload err:', error); return ''; }
            const { data: u } = sb.storage.from(STORAGE_BUCKET).getPublicUrl(filePath);
            return u.publicUrl;
        } catch (e) { console.error('Upload err:', e); return ''; }
    }

    async function deleteImage(url) {
        if (!url || !url.includes(STORAGE_BUCKET)) return;
        try {
            const p = url.split('/' + STORAGE_BUCKET + '/');
            if (p.length < 2) return;
            await sb.storage.from(STORAGE_BUCKET).remove([p[1].split('?')[0]]);
        } catch (e) { console.error('Delete err:', e); }
    }

    async function sendToTelegram(message, imageUrl) {
        try { await fetch('/api/telegram', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message, imageUrl }) }); } catch (e) { console.warn('Telegram:', e); }
    }

    let currentImgIndex = 0;
    let currentMode = 'white';
    let tagsData = [];
    let tempX = 0, tempY = 0;
    let activeFilter = 'all';
    let chartInstance = null;
    let currentPrintId = null;
    let navigationList = [];
    let currentCompareIndex = 0;
    let currentUser = null;
    let currentMachineId = '', currentAsset = null, allAssets = [];
    const counters = { white: 1, red: 1 };
    const idPrefix = { white: 'TAGW', red: 'TAGR' };

    function validateInput(input) { input.value = input.value.replace(/[^a-zA-Z0-9@._-]/g, ''); }

    // --- 2. AUTHENTICATION FUNCTIONS ---
    function switchAuth(mode) {
    // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å Form
    ['login-form', 'register-form', 'forgot-password-form'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
    });
    
    // ‡πÅ‡∏™‡∏î‡∏á Form ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    if(mode === 'register') {
        document.getElementById('register-form').classList.remove('hidden');
    } else if(mode === 'forgot') {
        document.getElementById('forgot-password-form').classList.remove('hidden');
    } else {
        // Default: Login Form
        document.getElementById('login-form').classList.remove('hidden');
    }
}

    function toggleLoading(show, text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...") {
        const el = document.getElementById('loading-screen');
        document.getElementById('loading-text').innerText = text;
        if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
    }

    async function handleRegister() {
        const name = document.getElementById('reg-name').value;
        const username = document.getElementById('reg-username').value;
        const password = document.getElementById('reg-password').value;
        const confirm = document.getElementById('reg-confirm-password').value;

        if(!name || !username || !password) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        if(password !== confirm) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô");

        toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...");
        try {
            const { data: existing } = await sb.from('Users').select('Username').eq('Username', username);
            if (existing && existing.length > 0) { toggleLoading(false); return alert("Username already exists"); }
            const { error } = await sb.from('Users').insert({ Username: username, Password: password, Name: name, Role: 'User' });
            toggleLoading(false);
            if (error) return alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
            alert("‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
            switchAuth('login');
        } catch (e) { toggleLoading(false); alert("Error: " + e); }
    }
async function handleForgotPassword() {
    const username = document.getElementById('forgot-username').value;
    const fullName = document.getElementById('forgot-fullname').value;
    const newPassword = document.getElementById('forgot-new-password').value;
    const confirm = document.getElementById('forgot-confirm-password').value;

    if(!username || !fullName || !newPassword) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    if(newPassword !== confirm) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô");
    if(newPassword.length < 4) return alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£");

    toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...");
    try {
        const { data: users } = await sb.from('Users').select('*').eq('Username', username);
        if (!users || users.length === 0 || users[0].Name !== fullName) {
            toggleLoading(false);
            return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô");
        }
        const { error } = await sb.from('Users').update({ Password: newPassword }).eq('Username', username);
        toggleLoading(false);
        if (error) return alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
        alert("‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà");
        ['forgot-username', 'forgot-fullname', 'forgot-new-password', 'forgot-confirm-password'].forEach(id => { document.getElementById(id).value = ''; });
        switchAuth('login');
    } catch (e) { toggleLoading(false); alert("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e); }
}

    async function handleLogin() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        if(!username || !password) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");

        toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...");
        try {
            const { data: users, error } = await sb.from('Users').select('*').eq('Username', username);
            toggleLoading(false);
            if (error || !users || users.length === 0 || users[0].Password !== password) {
                return alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: Login Fail");
            }
            const u = users[0];
            currentUser = { success: true, username: u.Username, name: u.Name, role: u.Role };
            showMainApp();
        } catch (e) { toggleLoading(false); alert("Error: " + e); }
    }

    function showMainApp() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('app-section').classList.remove('hidden');
        document.getElementById('app-section').classList.add('flex');
        document.getElementById('user-display-name').innerText = currentUser.name;
        
        const badge = document.getElementById('user-role-badge');
        badge.innerText = currentUser.role;
        if (currentUser.role === 'Admin') {
            badge.className = "px-2 py-0.5 text-[10px] rounded-full bg-violet-100 text-violet-700 font-bold border border-violet-200";
            document.getElementById('btn-admin-panel').classList.remove('hidden');
            document.getElementById('btn-asset-panel').classList.remove('hidden');
        } else {
            badge.className = "px-2 py-0.5 text-[10px] rounded-full bg-slate-200 text-slate-600";
            document.getElementById('btn-admin-panel').classList.add('hidden');
            document.getElementById('btn-asset-panel').classList.add('hidden');
        }

        initApp(); // Load Assets and Data
    }

    function logout() { location.reload(); }

    // --- 3. MAIN APP LOGIC ---
    async function initApp() {
        setMode('white');
        toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£...");
        try {
            const { data, error } = await sb.from('Assets').select('*');
            const assets = (data || []).map(r => {
                const imgs = (r.ImageURLs || '').split(',').map(s => s.trim()).filter(s => s !== '');
                return { id: r.AssetID || '', name: r.AssetName || '', images: imgs };
            });
            allAssets = assets;
            const hSelect = document.getElementById('machineSelect');
            if (assets && assets.length > 0) {
                hSelect.innerHTML = assets.map(a => `<option value="${a.id}">${a.name || a.id}</option>`).join('');
                changeAsset(assets[0].id);
                loadData();
            } else {
                if (currentUser.role === 'Admin') {
                    if(confirm("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) openAssetManager();
                } else {
                    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin");
                }
                toggleLoading(false);
            }
        } catch (e) { toggleLoading(false); alert("Error loading assets: " + e); }
    }

    function changeMachine() { changeAsset(document.getElementById('machineSelect').value); }

    function changeAsset(id) {
        currentMachineId = id;
        currentAsset = allAssets.find(a => a.id === id);
        if (currentAsset) {
            document.getElementById('asset-name-display').innerText = currentAsset.name;
            document.getElementById('print-group-name').innerText = currentAsset.name; // For Print
            document.getElementById('print-machine-name').innerText = currentAsset.name;
            document.getElementById('print-machine-id').innerText = currentAsset.id;
            
            currentImgIndex = 0;
            updateDisplay();
            loadData();
        }
    }

    function updateDisplay() { 
        if(currentAsset && currentAsset.images[currentImgIndex]) {
            document.getElementById('target-image').src = currentAsset.images[currentImgIndex]; 
            const pageText = `‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà ${currentImgIndex + 1} / ${currentAsset.images.length}`;
            document.getElementById('page-indicator').innerText = pageText;
            const mobileIndicator = document.getElementById('page-indicator-mobile');
            if (mobileIndicator) mobileIndicator.innerText = pageText;
            renderPins(); 
        } else if (currentAsset && currentAsset.images.length === 0) {
            document.getElementById('target-image').src = "https://via.placeholder.com/800x600?text=No+Image";
            document.getElementById('page-indicator').innerText = "0 / 0";
            const mobileIndicator = document.getElementById('page-indicator-mobile');
            if (mobileIndicator) mobileIndicator.innerText = "0 / 0";
            renderPins();
        }
    }
    
    window.changeImage = (dir) => { 
        if(!currentAsset || currentAsset.images.length === 0) return;
        currentImgIndex = (currentImgIndex + dir + currentAsset.images.length) % currentAsset.images.length; 
        updateDisplay(); 
    };

    async function loadData() {
        toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
        try {
            const { data, error } = await sb.from('repair_jobs').select('*');
            toggleLoading(false);
            if (error) { alert("Load Failed: " + error.message); return; }
            tagsData = (data || []).map(r => ({
                id: r.ID || '', type: r.Type || '', loc: r.Location || '',
                desc: r.Description || '', reporter: r.Reporter || '',
                reportTime: r.ReportTime || '', status: r.Status || '',
                resolver: r.Resolver || '', resolution: r.Resolution || '',
                fixTime: r.FixTime || '-', beforeImg: r.Before_Image_URL || '',
                afterImg: r.After_Image_URL || '', imgIndex: parseInt(r.ImgIndex) || 0,
                x: r.X !== null ? parseFloat(r.X) : 50, y: r.Y !== null ? parseFloat(r.Y) : 50,
                machineId: r["Machine ID"] || ''
            }));
            updateUI();
        } catch (e) { toggleLoading(false); alert("Load Failed: " + e); }
    }

    const convertBase64 = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error);
    });

    function toggleTheme(mode) {
        const html = document.documentElement;
        if (mode === 'dark') { html.classList.add('dark'); document.getElementById('btn-dark').classList.add('bg-slate-700', 'text-white'); document.getElementById('btn-light').classList.remove('bg-white', 'text-slate-800'); }
        else { html.classList.remove('dark'); document.getElementById('btn-light').classList.add('bg-white', 'text-slate-800'); document.getElementById('btn-dark').classList.remove('bg-slate-700', 'text-white'); }
        if(chartInstance) chartInstance.updateOptions({ theme: { mode: mode === 'dark' ? 'dark' : 'light' }, chart: { background: 'transparent' } });
    }
    toggleTheme('light');

    async function sendToGoogleSheet(tagData, action) {
        const statusEl = document.getElementById('sync-status'); statusEl.classList.remove('hidden');
        try {
            if (action === 'update') {
                const folderName = tagData.machineId || 'Uncategorized';
                let afterImgUrl = '';
                if (tagData.afterImg && tagData.afterImg.includes('base64,')) {
                    afterImgUrl = await uploadImage(tagData.afterImg, tagData.id + '_after.png', folderName);
                }
                const updateData = { Status: 'Fixed', Resolver: tagData.resolver, Resolution: tagData.resolution, FixTime: tagData.fixTime };
                if (afterImgUrl) updateData.After_Image_URL = afterImgUrl;
                const { error } = await sb.from('repair_jobs').update(updateData).eq('ID', tagData.id);
                statusEl.classList.add('hidden');
                if (error) alert("Save Error: " + error.message);
                else {
                    if (afterImgUrl) tagData.afterImg = afterImgUrl;
                    sendToTelegram("‚úÖ *‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢*\nID: " + tagData.id + "\nüõ† ‡∏ú‡∏π‡πâ‡∏ã‡πà‡∏≠‡∏°: " + tagData.resolver + "\nüîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: " + tagData.resolution, afterImgUrl);
                }
            }
        } catch (e) { statusEl.classList.add('hidden'); alert("Conn Error: " + e); }
    }

    // --- NEW: Generate Next ID per Machine & Color ---
    function generateNextId(type, machineId) {
        const prefix = idPrefix[type]; 
        // Filter by Machine AND Type
        const existingTags = tagsData.filter(t => t.machineId === machineId && t.type === type);
        let maxNum = 0;
        existingTags.forEach(t => {
            const parts = t.id.split('-');
            const numPart = parseInt(parts[parts.length - 1]);
            if (!isNaN(numPart) && numPart > maxNum) maxNum = numPart;
        });
        return `${prefix}-${machineId}-${String(maxNum + 1).padStart(3, '0')}`;
    }

    // --- NEW: Standard Date Formatter (dd/mm/yyyy HH:MM) with BE Year ---
    function getThaiFormattedDate() {
        const now = new Date();
        const d = String(now.getDate()).padStart(2, '0');
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const y = now.getFullYear() + 543;
        const h = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        return `${d}/${m}/${y} ${h}:${min}`;
    }

    // --- INTERACTIONS ---
    document.getElementById('img-wrapper').addEventListener('click', (e) => {
        if (e.target.closest('.tag-pin')) return;
        const rect = e.currentTarget.getBoundingClientRect();
        tempX = ((e.clientX - rect.left) / rect.width) * 100; tempY = ((e.clientY - rect.top) / rect.height) * 100;
        
        ['add-loc','add-desc','add-image'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('add-reporter').value = currentUser ? currentUser.name : '';
        document.getElementById('preview-add').style.display = 'none';
        document.getElementById('modal-add').classList.remove('hidden'); document.getElementById('modal-add').classList.add('flex');
    });

    window.saveTag = async () => {
        const loc = document.getElementById('add-loc').value;
        const desc = document.getElementById('add-desc').value;
        const file = document.getElementById('add-image').files[0];
        if(!loc || !desc) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
        const b64 = file ? await convertBase64(file) : "";
        
        const newId = generateNextId(currentMode, currentMachineId);
        const reportTimeFormatted = getThaiFormattedDate();
        const folderName = currentMachineId || 'Uncategorized';
        const beforeImgUrl = await uploadImage(b64, newId + '_before.png', folderName);

        const insertData = {
            ID: newId, Type: currentMode, Location: loc, Description: desc,
            Reporter: currentUser.name, ReportTime: reportTimeFormatted,
            Status: 'Open', Resolver: '-', Resolution: '-', FixTime: null,
            Before_Image_URL: beforeImgUrl, After_Image_URL: '',
            ImgIndex: currentImgIndex, X: parseFloat(tempX.toFixed(2)), Y: parseFloat(tempY.toFixed(2)),
            "Machine ID": currentMachineId
        };

        try {
            const { error } = await sb.from('repair_jobs').insert(insertData);
            if (error) { toggleLoading(false); return alert("Save Error: " + error.message); }

            tagsData.push({
                id: newId, machineId: currentMachineId, type: currentMode,
                loc, desc, reporter: currentUser.name, reportTime: reportTimeFormatted,
                status: 'Open', imgIndex: currentImgIndex, x: tempX, y: tempY,
                beforeImg: beforeImgUrl, afterImg: '', resolver: '-', resolution: '-', fixTime: '-'
            });
            closeModal('modal-add'); updateUI();

            if (currentMode === 'red' || currentMode === 'yellow_red') {
                const icon = currentMode === 'red' ? 'üî¥' : 'üü°üî¥';
                sendToTelegram(icon + " *‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏î‡πà‡∏ß‡∏ô*\nID: " + newId + "\nü§ñ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á: " + currentMachineId + "\nüìç ‡∏à‡∏∏‡∏î: " + loc + "\nüìù ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£: " + desc, beforeImgUrl);
            }
        } catch (e) { alert("Error: " + e); }
        toggleLoading(false);
    };

    window.submitFix = async () => {
        const id = document.getElementById('fix-tag-id').value; 
        const resolver = document.getElementById('fix-resolver').value; 
        const resolution = document.getElementById('fix-resolution').value;
        if(!resolver || !resolution) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        const tag = tagsData.find(t => t.id === id);
        if(tag) {
            let afterImg = null; if(document.getElementById('fix-image').files[0]) afterImg = await convertBase64(document.getElementById('fix-image').files[0]);
            tag.status = 'Fixed'; tag.resolver = resolver; tag.resolution = resolution; 
            
            // FIX: Use new date format function
            tag.fixTime = getThaiFormattedDate(); 
            
            tag.afterImg = afterImg;
            sendToGoogleSheet(tag, 'update');
        }
        closeModal('modal-fix'); updateUI();
    };

    // --- MODALS & ADMIN ---
    window.deleteTag = async (id) => {
        if (!currentUser || currentUser.role !== 'Admin') return;
        if(confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ñ‡∏≤‡∏ß‡∏£)")) {
            const statusEl = document.getElementById('sync-status'); statusEl.classList.remove('hidden'); statusEl.innerHTML = '<i class="fa-solid fa-trash animate-bounce"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';
            try {
                const { data: existing } = await sb.from('repair_jobs').select('*').eq('ID', id);
                if (existing && existing.length > 0) {
                    if (existing[0].Before_Image_URL) deleteImage(existing[0].Before_Image_URL);
                    if (existing[0].After_Image_URL) deleteImage(existing[0].After_Image_URL);
                }
                const { error } = await sb.from('repair_jobs').delete().eq('ID', id);
                statusEl.classList.add('hidden');
                if (error) return alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);
                tagsData = tagsData.filter(t => t.id !== id); updateUI();
            } catch (e) { statusEl.classList.add('hidden'); alert("Error: " + e); }
        }
    };

    window.openEditModal = (id) => {
    const tag = tagsData.find(t => t.id === id); 
    if(!tag) return;
    
    // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏Å‡∏ï‡∏¥
    document.getElementById('edit-old-id').value = tag.id;
    document.getElementById('edit-id').value = tag.id;
    document.getElementById('edit-type').value = tag.type;
    document.getElementById('edit-reporter').value = tag.reporter;
    document.getElementById('edit-loc').value = tag.loc;
    document.getElementById('edit-desc').value = tag.desc;
    document.getElementById('edit-image').value = '';
    document.getElementById('edit-image-after').value = ''; 
    
    // ‚úÖ NEW: Admin ‡πÄ‡∏´‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    if (currentUser && currentUser.role === 'Admin') {
        const dateFields = document.getElementById('admin-date-fields');
        if(dateFields) {
            dateFields.style.display = 'block';
            document.getElementById('edit-report-time').value = tag.reportTime || '';
            document.getElementById('edit-fix-time').value = tag.fixTime && tag.fixTime !== '-' ? tag.fixTime : '';
        }
    } else {
        const dateFields = document.getElementById('admin-date-fields');
        if(dateFields) dateFields.style.display = 'none';
    }
    
    // Preview ‡∏£‡∏π‡∏õ Before
    const pBefore = document.getElementById('preview-edit');
    if (tag.beforeImg) { 
        pBefore.src = tag.beforeImg; 
        pBefore.style.display = 'block'; 
    } else { 
        pBefore.style.display = 'none'; 
    }
    
    // Preview ‡∏£‡∏π‡∏õ After
    const pAfter = document.getElementById('preview-edit-after');
    if (tag.afterImg) { 
        pAfter.src = tag.afterImg; 
        pAfter.style.display = 'block'; 
    } else { 
        pAfter.style.display = 'none'; 
    }
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Modal
    document.getElementById('modal-edit').classList.remove('hidden'); 
    document.getElementById('modal-edit').classList.add('flex');
};


    window.saveEdit = async () => {
    const oldId = document.getElementById('edit-old-id').value;
    const newId = document.getElementById('edit-id').value;
    const type = document.getElementById('edit-type').value;
    const reporter = document.getElementById('edit-reporter').value;
    const loc = document.getElementById('edit-loc').value;
    const desc = document.getElementById('edit-desc').value;
    const imgFile = document.getElementById('edit-image').files[0];
    const imgFileAfter = document.getElementById('edit-image-after').files[0];

    if(!newId || !reporter || !loc || !desc) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

    const tag = tagsData.find(t => t.id === oldId);
    const machineId = tag ? tag.machineId : "";
    const folderName = machineId || 'Uncategorized';

    let reportTime = null, fixTime = null;
    if (currentUser && currentUser.role === 'Admin') {
        const reportTimeEl = document.getElementById('edit-report-time');
        const fixTimeEl = document.getElementById('edit-fix-time');
        if(reportTimeEl) reportTime = reportTimeEl.value.trim() || null;
        if(fixTimeEl) fixTime = fixTimeEl.value.trim() || null;
    }

    const statusEl = document.getElementById('sync-status');
    statusEl.classList.remove('hidden');
    statusEl.innerHTML = '<i class="fa-solid fa-pen animate-bounce"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...';

    try {
        const updateData = { ID: newId, Type: type, Location: loc, Description: desc, Reporter: reporter };
        if (reportTime) updateData.ReportTime = reportTime;
        if (fixTime) updateData.FixTime = fixTime;

        if (imgFile) {
            const b64 = await convertBase64(imgFile);
            if (tag && tag.beforeImg) deleteImage(tag.beforeImg);
            const bUrl = await uploadImage(b64, newId + '_before_fixed.png', folderName);
            if (bUrl) updateData.Before_Image_URL = bUrl;
        }
        if (imgFileAfter) {
            const b64 = await convertBase64(imgFileAfter);
            if (tag && tag.afterImg) deleteImage(tag.afterImg);
            const aUrl = await uploadImage(b64, newId + '_after_fixed.png', folderName);
            if (aUrl) updateData.After_Image_URL = aUrl;
        }

        const { error } = await sb.from('repair_jobs').update(updateData).eq('ID', oldId);
        statusEl.classList.add('hidden');
        if (error) return alert("‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message);

        if (tag) {
            tag.id = newId; tag.type = type; tag.reporter = reporter; tag.loc = loc; tag.desc = desc;
            if (updateData.Before_Image_URL) tag.beforeImg = updateData.Before_Image_URL;
            if (updateData.After_Image_URL) tag.afterImg = updateData.After_Image_URL;
            if (reportTime) tag.reportTime = reportTime;
            if (fixTime) tag.fixTime = fixTime;
        }
        closeModal('modal-edit'); updateUI();
        alert("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    } catch (e) { statusEl.classList.add('hidden'); alert("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e); }
};


    function openAssetManager() {
        if(currentUser.role !== 'Admin') return;
        document.getElementById('modal-asset-manager').classList.remove('hidden');
        document.getElementById('modal-asset-manager').classList.add('flex');
        if(currentAsset) {
            document.getElementById('manage-asset-id').value = currentAsset.id;
            document.getElementById('manage-asset-name').value = currentAsset.name;
        }
    }

    window.saveAssetConfig = async () => {
        const id = document.getElementById('manage-asset-id').value;
        const name = document.getElementById('manage-asset-name').value;
        const files = document.getElementById('asset-upload-images').files;
        if(!id || !name) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

        toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£...");
        try {
            let newUrls = [];
            for (let i = 0; i < files.length; i++) {
                const b64 = await convertBase64(files[i]);
                const url = await uploadImage(b64, 'Asset_' + id + '_' + Date.now() + '_' + i + '.png', id);
                if (url) newUrls.push(url);
            }

            const currentImgsArr = (currentAsset && currentAsset.images) ? currentAsset.images : [];
            const finalImgs = currentImgsArr.concat(newUrls).filter(x => x && x.trim() !== '');
            const finalImgStr = finalImgs.join(',');

            const { data: existing } = await sb.from('Assets').select('*').eq('AssetID', id);
            if (existing && existing.length > 0) {
                const { error } = await sb.from('Assets').update({ AssetName: name, ImageURLs: finalImgStr }).eq('AssetID', id);
                toggleLoading(false);
                if (error) return alert("Error: " + error.message);
            } else {
                const { error } = await sb.from('Assets').insert({ AssetID: id, AssetName: name, ImageURLs: finalImgStr });
                toggleLoading(false);
                if (error) return alert("Error: " + error.message);
            }
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); closeModal('modal-asset-manager'); location.reload();
        } catch (e) { toggleLoading(false); alert("Error: " + e); }
    };

    window.deleteSelectedImages = async () => {
        const indicesStr = document.getElementById('delete-image-indices').value;
        if(!indicesStr) return alert("‡∏£‡∏∞‡∏ö‡∏∏‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏π‡∏õ");
        if(!currentAsset) return;
        const indices = indicesStr.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà: " + indices.join(', '))) {
            toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏£‡∏π‡∏õ...");
            try {
                let currentImages = [...currentAsset.images];
                const sorted = indices.sort((a, b) => b - a);
                sorted.forEach(idx => {
                    if (idx >= 0 && idx < currentImages.length) {
                        deleteImage(currentImages[idx]);
                        currentImages.splice(idx, 1);
                    }
                });
                const { error } = await sb.from('Assets').update({ ImageURLs: currentImages.join(',') }).eq('AssetID', currentAsset.id);
                toggleLoading(false);
                if (error) return alert("Error: " + error.message);
                alert("‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); location.reload();
            } catch (e) { toggleLoading(false); alert("Error: " + e); }
        }
    };

    window.openFixModal = (id) => {
        const tag = tagsData.find(t => t.id === id); if (!tag) return;
        document.getElementById('fix-tag-id').value = id;
        document.getElementById('fix-resolver').value = currentUser ? currentUser.name : ''; 
        document.getElementById('fix-resolution').value = ''; 
        document.getElementById('fix-image').value = ''; 
        document.getElementById('preview-fix').style.display = 'none';
        const imgBefore = document.getElementById('fix-preview-before');
        if (tag.beforeImg) { imgBefore.src = tag.beforeImg; imgBefore.classList.remove('hidden'); } else { imgBefore.src = ''; imgBefore.classList.add('hidden'); }
        document.getElementById('modal-fix').classList.remove('hidden'); document.getElementById('modal-fix').classList.add('flex'); 
    };

    window.openCompareModal = (id) => {
    const tag = tagsData.find(t => t.id === id); if (!tag) return;
    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏° && t.machineId === currentMachineId
    if (tag.status === 'Fixed') { 
        navigationList = tagsData.filter(t => t.status === 'Fixed' && t.machineId === currentMachineId); 
    } else { 
        navigationList = tagsData.filter(t => t.status === 'Open' && t.machineId === currentMachineId); 
    }
    const index = navigationList.findIndex(t => t.id === id);
    if (index !== -1) { currentCompareIndex = index; renderCompareView(); document.getElementById('modal-compare').classList.remove('hidden'); document.getElementById('modal-compare').classList.add('flex'); }
};

    window.switchCompareResult = (step) => {
        if(navigationList.length === 0) return;
        currentCompareIndex = (currentCompareIndex + step + navigationList.length) % navigationList.length;
        renderCompareView();
    };

    function renderCompareView() {
        const tag = navigationList[currentCompareIndex]; if(!tag) return;
        currentPrintId = tag.id; 
        document.getElementById('compare-counter').innerText = `${currentCompareIndex + 1} / ${navigationList.length}`;
        document.getElementById('compare-tag-id').innerText = `TAG: ${tag.id}`;
        document.getElementById('compare-report-time').innerText = tag.reportTime; document.getElementById('compare-reporter').innerText = tag.reporter; document.getElementById('compare-desc').innerText = tag.desc;
        document.getElementById('compare-fix-time').innerText = tag.fixTime; document.getElementById('compare-resolver').innerText = tag.resolver; document.getElementById('compare-resolution').innerText = tag.resolution;
        const i1 = document.getElementById('compare-img-before'); const n1 = document.getElementById('no-img-before');
        i1.onerror = function() { i1.classList.add('hidden'); n1.classList.remove('hidden'); };
        if(tag.beforeImg) { i1.src = tag.beforeImg; i1.classList.remove('hidden'); n1.classList.add('hidden'); } else { i1.classList.add('hidden'); n1.classList.remove('hidden'); }
        const i2 = document.getElementById('compare-img-after'); const n2 = document.getElementById('no-img-after');
        i2.onerror = function() { i2.classList.add('hidden'); n2.classList.remove('hidden'); n2.innerText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"; };
        if(tag.status === 'Fixed' && tag.afterImg) { i2.src = tag.afterImg; i2.classList.remove('hidden'); n2.classList.add('hidden'); } else { i2.classList.add('hidden'); n2.classList.remove('hidden'); n2.innerText = "(‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)"; }
    }

    window.printForm = () => {
        const tag = tagsData.find(t => t.id === currentPrintId); if(!tag) return;
        let title = ""; let footerCode = "TPM-104 rev.0"; 
        if(tag.type === 'white') { title = "‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; footerCode = "TPM-104 rev.0"; } 
        else if(tag.type === 'red') { title = "‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; footerCode = "TPM-104S rev.0"; } 
        else if(tag.type === 'yellow_white') { title = "‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; footerCode = "TPM-104 rev.0"; } 
        else { title = "‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; footerCode = "TPM-104S rev.0"; }
            
        document.getElementById('print-title').innerText = title; document.getElementById('print-footer-code').innerText = footerCode; document.getElementById('print-ref').innerText = tag.id;
        const imgB = document.getElementById('print-img-before'); imgB.src = tag.beforeImg || ""; imgB.style.display = tag.beforeImg ? 'block' : 'none'; document.getElementById('print-no-before').style.display = tag.beforeImg ? 'none' : 'block';
        const imgA = document.getElementById('print-img-after'); imgA.src = tag.afterImg || ""; imgA.style.display = tag.afterImg ? 'block' : 'none'; document.getElementById('print-no-after').style.display = tag.afterImg ? 'none' : 'block';
        document.getElementById('print-problem').innerText = tag.desc; document.getElementById('print-solution').innerText = tag.resolution; document.getElementById('print-loc').innerText = tag.loc;
        document.getElementById('print-finder').innerText = tag.reporter; document.getElementById('print-date-found').innerText = tag.reportTime; document.getElementById('print-fixer').innerText = tag.resolver; document.getElementById('print-date-fixed').innerText = tag.fixTime;
        window.print();
    };

    // --- ADMIN: User Management ---
    async function openUserManagement() {
        if (!currentUser || currentUser.role !== 'Admin') return alert("Access Denied");
        toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...");
        try {
            const { data: users, error } = await sb.from('Users').select('Username,Name,Role');
            toggleLoading(false);
            if (error) return alert("Error: " + error.message);
            const tbody = document.getElementById('user-list-body'); tbody.innerHTML = '';
            (users || []).forEach(u => {
                const isSelf = (u.Username === currentUser.username);
                let roleSelect = isSelf ? `<span class="font-bold text-violet-600 bg-violet-50 px-2 py-1 rounded">Admin (‡∏Ñ‡∏∏‡∏ì)</span>` :
                `<select onchange="changeUserRole('${u.Username}', this.value)" class="bg-white border rounded px-2 py-1 text-xs outline-none focus:ring-2 focus:ring-primary-500 dark:bg-slate-700 dark:text-white"><option value="User" ${u.Role === 'User' ? 'selected' : ''}>User</option><option value="Admin" ${u.Role === 'Admin' ? 'selected' : ''}>Admin</option></select>`;
                const row = `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800 border-b dark:border-slate-800"><td class="p-3 text-slate-700 dark:text-slate-300">${u.Username}</td><td class="p-3 text-slate-700 dark:text-slate-300 font-medium">${u.Name}</td><td class="p-3">${roleSelect}</td></tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            document.getElementById('modal-users').classList.remove('hidden'); document.getElementById('modal-users').classList.add('flex');
        } catch (e) { toggleLoading(false); alert("Error: " + e); }
    }

    window.changeUserRole = async (targetUsername, newRole) => {
        if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ç‡∏≠‡∏á ${targetUsername} ‡πÄ‡∏õ‡πá‡∏ô ${newRole} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) { openUserManagement(); return; }
        toggleLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...");
        try {
            const { error } = await sb.from('Users').update({ Role: newRole }).eq('Username', targetUsername);
            toggleLoading(false);
            if (error) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message); openUserManagement(); return; }
            if(targetUsername === currentUser.username) { currentUser.role = newRole; showMainApp(); }
            openUserManagement();
        } catch (e) { toggleLoading(false); alert("Error: " + e); }
    }

    // --- HELPERS ---
    window.openHelpModal = () => { document.getElementById('modal-help').classList.remove('hidden'); document.getElementById('modal-help').classList.add('flex'); };
    window.closeModal = (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); };
    
    window.setMode = (m) => { 
        currentMode = m; 
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° desktop
        ['white','red'].forEach(x => {
            const btn = document.getElementById('btn-mode-'+x);
            if (btn) btn.classList.remove('ring-2','ring-slate-400','ring-red-500','ring-yellow-400','active','shadow-md');
        }); 
        const b = document.getElementById('btn-mode-'+m); 
        if (b) {
            b.classList.add('active','shadow-md'); 
            if(m=='white') b.classList.add('ring-2','ring-slate-400'); 
            else if(m=='red') b.classList.add('ring-2','ring-red-500'); 
            else b.classList.add('ring-2','ring-yellow-400');
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° mobile
        ['white','red'].forEach(x => {
            const btnMobile = document.getElementById('btn-mode-'+x+'-mobile');
            if (btnMobile) btnMobile.classList.remove('ring-2','ring-slate-400','ring-red-500','ring-yellow-400','active','shadow-md','bg-slate-100','dark:bg-slate-700');
        }); 
        const bMobile = document.getElementById('btn-mode-'+m+'-mobile'); 
        if (bMobile) {
            bMobile.classList.add('active','shadow-md','bg-slate-100','dark:bg-slate-700'); 
            if(m=='white') bMobile.classList.add('ring-2','ring-slate-400'); 
            else if(m=='red') bMobile.classList.add('ring-2','ring-red-500'); 
            else bMobile.classList.add('ring-2','ring-yellow-400');
        }
    };
    window.applyFilter = () => { activeFilter = document.getElementById('filter-color').value; renderTables(); renderPins(); };
    window.switchTab = (t) => { const a = document.getElementById('tab-active'); const h = document.getElementById('tab-history'); const va = document.getElementById('view-active'); const vh = document.getElementById('view-history'); if(t === 'active') { va.classList.remove('hidden'); vh.classList.add('hidden'); a.classList.add('text-primary-600','border-primary-600','bg-primary-50','dark:text-cyan-400','dark:border-cyan-400'); h.classList.remove('text-primary-600','border-primary-600','bg-primary-50','dark:text-cyan-400','dark:border-cyan-400'); } else { va.classList.add('hidden'); vh.classList.remove('hidden'); h.classList.add('text-primary-600','border-primary-600','bg-primary-50','dark:text-cyan-400','dark:border-cyan-400'); a.classList.remove('text-primary-600','border-primary-600','bg-primary-50','dark:text-cyan-400','dark:border-cyan-400'); } };

    function updateUI() { 
        renderPins(); 
        renderTables(); 
        updateStats(); // Ensure stats update after data load
    }
    
    function updateStats() { 
        // Important: Ensure we filter by current machine
        const filtered = tagsData.filter(t => t.machineId === currentMachineId);
        
        const total = filtered.length; 
        const fixed = filtered.filter(t => t.status === 'Fixed').length; 
        const totalPct = total === 0 ? 0 : Math.round((fixed / total) * 100); 
        
        document.getElementById('stat-total-percent').innerText = totalPct + '%'; 
        document.getElementById('stat-total-count').innerText = total; 
        
        const calc = (types) => { 
            const t = filtered.filter(x => types.includes(x.type)).length; 
            if(t === 0) return { pct: 0, str: '0%', count_str: '0/0' }; 
            const f = filtered.filter(x => types.includes(x.type) && x.status === 'Fixed').length; 
            const p = Math.round((f / t) * 100); 
            return { pct: p, str: p + '%', count_str: `${f}/${t}` }; 
        }; 
        
        const w = calc(['white']); 
        document.getElementById('stat-white-percent').innerText = w.str; 
        document.getElementById('stat-white-count').innerText = w.count_str; 
        document.getElementById('bar-white').style.width = w.str; 
        
        const r = calc(['red']); 
        document.getElementById('stat-red-percent').innerText = r.str; 
        document.getElementById('stat-red-count').innerText = r.count_str; 
        document.getElementById('bar-red').style.width = r.str; 
        
        const y = 0; // ‡πÑ‡∏°‡πà‡∏°‡∏µ tag ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ 
        document.getElementById('stat-yellow-percent').innerText = y.str; 
        document.getElementById('stat-yellow-count').innerText = y.count_str; 
        document.getElementById('bar-yellow').style.width = y.str; 
        
        document.getElementById('sub-stat-white').innerText = w.str; 
        document.getElementById('sub-stat-red').innerText = r.str; 
        document.getElementById('sub-stat-yellow').innerText = y.str; 
    }
        
    function renderPins() { 
        const l = document.getElementById('pins-layer'); 
        l.innerHTML = ''; 
        tagsData.filter(x => x.machineId === currentMachineId && x.imgIndex === currentImgIndex && (activeFilter === 'all' || x.type === activeFilter)).forEach(tag => { 
            const p = document.createElement('div'); 
            let bgClass = ''; 
            if (tag.type === 'white') bgClass = 'bg-slate-500 text-white'; 
            else if (tag.type === 'red') bgClass = 'bg-red-500 text-white'; 
            else if (tag.type.includes('yellow')) bgClass = 'bg-yellow-400 text-slate-900'; 
            
            let borderClass = 'border-2 border-white'; 
            if (tag.type === 'yellow_red') { borderClass = 'border-4 border-red-600'; } 
            
            let statusClass = ''; 
            let iconContent = ''; 
            let idParts = tag.id.split('-'); 
            let idNum = idParts[idParts.length-1]; 
            
            if (tag.status === 'Fixed') { 
                statusClass = 'ring-4 ring-emerald-500 ring-offset-1'; 
                iconContent = `<div class="flex items-center justify-center"><i class="fa-solid fa-check text-[8px] mr-0.5"></i>${idNum}</div>`; 
            } else { 
                if (tag.type === 'yellow_red') statusClass = 'danger-tech-pulse'; 
                else if (tag.type === 'red') statusClass = 'animate-pulse'; 
                iconContent = `<span>${idNum}</span>`; 
            } 
            
            p.className = `tag-pin absolute w-10 h-10 rounded-full flex items-center justify-center font-bold text-[10px] cursor-pointer transform pointer-events-auto z-20 shadow-lg ${bgClass} ${borderClass} ${statusClass}`; 
            p.style.left = tag.x+'%'; 
            p.style.top = tag.y+'%'; 
            p.style.transform = 'translate(-50%,-50%)'; 
            p.innerHTML = iconContent; 
            p.onclick = (e) => { e.stopPropagation(); tag.status==='Open' ? openFixModal(tag.id) : openCompareModal(tag.id); }; 
            l.appendChild(p); 
        }); 
    }
    
    function renderTables() { 
        const a = document.getElementById('tbody-active'); 
        const h = document.getElementById('tbody-history'); 
        a.innerHTML=''; h.innerHTML=''; 
        let ac=0; let hc=0; 
        const isAdmin = (currentUser && currentUser.role === 'Admin');

        tagsData.filter(t => t.machineId === currentMachineId && (activeFilter === 'all' || t.type === activeFilter)).forEach(tag => { 
            let b = ''; 
            if(tag.type==='white') b='<span class="bg-slate-100 text-slate-600 px-2 rounded text-[10px] font-bold">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span>'; 
            else if(tag.type==='red') b='<span class="bg-red-100 text-red-600 px-2 rounded text-[10px] font-bold">‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ</span>'; 
            else if(tag.type.includes('yellow')) b='<span class="bg-yellow-100 text-yellow-700 border border-yellow-200 px-2 rounded text-[10px] font-bold">‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢</span>'; 
            
            const btnEdit = `<button onclick="openEditModal('${tag.id}')" class="text-xs text-slate-400 hover:text-primary-600 transition-colors mr-1" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i class="fa-solid fa-pen-to-square"></i></button>`;
            const imgIcon = tag.beforeImg ? '<i class="fa-regular fa-image text-slate-400 ml-1"></i>' : ''; 

            let actionBtn = '';
            if (tag.status === 'Open') {
                actionBtn = `<button onclick="openFixModal('${tag.id}')" class="text-xs bg-emerald-50 text-emerald-600 hover:bg-emerald-600 hover:text-white px-3 py-1 rounded border border-emerald-100 transition-colors">‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>`;
            } else {
                actionBtn = `<button onclick="openCompareModal('${tag.id}')" class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white px-3 py-1 rounded border border-indigo-100 transition-colors">‡∏î‡∏π‡∏ú‡∏•‡∏á‡∏≤‡∏ô</button>`;
            }

            const btnDelete = isAdmin ? `<button onclick="deleteTag('${tag.id}')" class="text-xs bg-red-50 text-red-500 hover:bg-red-500 hover:text-white px-2 py-1 rounded border border-red-100 ml-1 transition-colors"><i class="fa-solid fa-trash"></i></button>` : ``;

            // Row ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TAG ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ã‡πà‡∏≠‡∏° (Active)
            const rowActive = `<tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 border-b border-slate-100 dark:border-slate-800">
                <td class="px-4 py-3 align-top">
                    <div class="flex items-center gap-1 flex-wrap"><div class="font-bold text-slate-700 dark:text-slate-200 text-xs">${tag.id}</div>${btnEdit}${imgIcon}</div>
                    <div class="text-xs text-slate-400">${tag.reportTime}</div>
                    <div class="mt-1">${b}</div>
                </td>
                <td class="px-4 py-3 align-top">
                    <div class="font-medium text-slate-800 dark:text-slate-100 text-sm">${tag.loc}</div>
                    <div class="text-xs text-slate-500 break-words">"${tag.desc}"</div>
                    <div class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-user"></i> ${tag.reporter}</div>
                </td>
                <td class="px-4 py-3 align-top text-right">
                    <div class="flex justify-end items-center gap-1 flex-wrap">${actionBtn}${btnDelete}</div>
                </td>
            </tr>`;
            
            // Row ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TAG ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß (History) - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö header: ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ | ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç | ‡∏î‡∏π‡∏ú‡∏•‡∏á‡∏≤‡∏ô
            const rowHistory = `<tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 border-b border-slate-100 dark:border-slate-800">
                <td class="px-4 py-3 align-top">
                    <div class="flex items-center gap-1 flex-wrap"><div class="font-bold text-slate-700 dark:text-slate-200 text-xs">${tag.id}</div>${btnEdit}${imgIcon}</div>
                    <div class="text-xs text-slate-400">${tag.reportTime}</div>
                    <div class="mt-1">${b}</div>
                    <div class="text-xs text-slate-500 mt-1 break-words">"${tag.desc}"</div>
                    <div class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-user"></i> ${tag.reporter}</div>
                </td>
                <td class="px-4 py-3 align-top">
                    <div class="font-medium text-emerald-600 dark:text-emerald-400 text-sm break-words">${tag.resolution || '-'}</div>
                    <div class="text-[10px] text-slate-400 mt-1"><i class="fa-solid fa-wrench mr-1"></i>${tag.resolver || '-'}</div>
                    <div class="text-[10px] text-slate-400"><i class="fa-solid fa-calendar-check mr-1"></i>${tag.fixTime || '-'}</div>
                </td>
                <td class="px-4 py-3 align-top text-right">
                    <div class="flex justify-end items-center gap-1 flex-wrap">${actionBtn}${btnDelete}</div>
                </td>
            </tr>`; 
            
            if(tag.status==='Open') { ac++; a.insertAdjacentHTML('beforeend', rowActive); } 
            else { hc++; h.insertAdjacentHTML('beforeend', rowHistory); } 
        }); 
        document.getElementById('empty-active').style.display = ac===0?'block':'none'; 
        document.getElementById('empty-history').style.display = hc===0?'block':'none'; 
    }

    // --- FIX: Robust Date Parsing for Chart ---
    function parseDate(str) {
        if(!str) return null;
        try {
            // Support formats like "28/1/2569", "28/01/2026 14:30", "28-1-2569"
            // Split date part from time (if exists)
            const datePart = str.split(' ')[0];
            // Split day, month, year
            const parts = datePart.split(/[-/]/);
            
            if(parts.length === 3) {
                let d = parseInt(parts[0]);
                let m = parseInt(parts[1]) - 1; // Month is 0-indexed
                let y = parseInt(parts[2]);
                
                // Convert Thai Year (BE) to AD
                if (y > 2400) y -= 543; 
                
                return new Date(y, m, d);
            }
        } catch(e) { 
            console.error("Date Parse Error:", str); 
        }
        return null;
    }

    // --- FIX: Ensure Modal is ready before Chart Init ---
    window.openChartModal = () => { 
        const s = document.getElementById('chart-year'); 
        const c = new Date().getFullYear(); 
        s.innerHTML = ''; 
        for(let y=c; y>=c-2; y--) { 
            let o = document.createElement('option'); 
            o.value = y; 
            o.text = '‡∏õ‡∏µ '+y; 
            if(y===c) o.selected = true; 
            s.appendChild(o); 
        } 
        document.getElementById('modal-chart').classList.remove('hidden'); 
        document.getElementById('modal-chart').classList.add('flex'); 
        
        // Timeout allows DOM layout to finish before ApexCharts calculates width
        setTimeout(initChart, 200); 
    };
    
    function initChart() {
        if (!document.querySelector("#chart-container")) return;
        const yrEl = document.getElementById('chart-year');
        if (!yrEl.value) return;

        const yr = parseInt(yrEl.value);
        const typeFilter = document.getElementById('chart-type-filter').value;
        const m = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
        const rd = new Array(12).fill(0); // Reported
        const fd = new Array(12).fill(0); // Fixed
        
        const dark = document.documentElement.classList.contains('dark');
        
        // Config Colors
        let barColor = dark ? '#818cf8' : '#6366f1'; 
        if (typeFilter === 'white') barColor = dark ? '#94a3b8' : '#64748b'; 
        else if (typeFilter === 'red') barColor = dark ? '#f87171' : '#ef4444'; 
        else if (typeFilter.includes('yellow')) barColor = dark ? '#fbbf24' : '#eab308'; 

        // Filter Data by Machine & Type
        tagsData.filter(t => t.machineId === currentMachineId).forEach(t => {
            // Apply Type Filter
            if (typeFilter !== 'all') {
                if (typeFilter.includes('yellow')) { if (!t.type.includes('yellow')) return; } 
                else { if (t.type !== typeFilter) return; }
            }
            
            // Count Reported (using reportTime)
            const d = parseDate(t.reportTime);
            if (d && d.getFullYear() === yr) rd[d.getMonth()]++;
            
            // Count Fixed (using fixTime)
            const f = parseDate(t.fixTime);
            if (t.status === 'Fixed' && f && f.getFullYear() === yr) fd[f.getMonth()]++;
        });

        const opt = {
            series: [
                { name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏à‡πâ‡∏á (Reported)', type: 'column', data: rd }, 
                { name: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß (Fixed)', type: 'line', data: fd }
            ],
            chart: { height: 350, type: 'line', toolbar: { show: false }, background: 'transparent', fontFamily: 'Sarabun, sans-serif' },
            stroke: { width: [0, 4], curve: 'smooth' },
            colors: [barColor, '#10b981'],
            labels: m,
            xaxis: { labels: { style: { colors: dark ? '#94a3b8' : '#475569', fontSize: '12px' } }, axisBorder: { show: false }, axisTicks: { show: false } },
            yaxis: { labels: { style: { colors: dark ? '#94a3b8' : '#475569' }, formatter: (v) => Math.floor(v) } },
            legend: { position: 'top', labels: { colors: dark ? '#cbd5e1' : '#475569' } },
            grid: { borderColor: dark ? '#1e293b' : '#f1f5f9', strokeDashArray: 4 },
            theme: { mode: dark ? 'dark' : 'light' },
            tooltip: { theme: dark ? 'dark' : 'light', y: { formatter: (val) => val + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" } },
            plotOptions: { bar: { borderRadius: 6, columnWidth: '45%' } },
            markers: { size: 4, strokeColors: dark ? '#0f172a' : '#fff', strokeWidth: 2 }
        };

        if (chartInstance) chartInstance.destroy();
        chartInstance = new ApexCharts(document.querySelector("#chart-container"), opt);
        chartInstance.render();
    }

    document.getElementById('edit-image').addEventListener('change', async function() { if (this.files[0]) { const b64 = await convertBase64(this.files[0]); resetRotation('preview-edit'); document.getElementById('preview-edit').src = b64; document.getElementById('preview-edit').style.display = 'block'; document.getElementById('rotate-preview-edit').style.display = 'flex'; } });
    document.getElementById('edit-image-after').addEventListener('change', async function() { if (this.files[0]) { const b64 = await convertBase64(this.files[0]); resetRotation('preview-edit-after'); const p = document.getElementById('preview-edit-after'); p.src = b64; p.style.display = 'block'; document.getElementById('rotate-preview-edit-after').style.display = 'flex'; } });
    document.getElementById('add-image').addEventListener('change', async function() { if (this.files[0]) { const b64 = await convertBase64(this.files[0]); resetRotation('preview-add'); document.getElementById('preview-add').src = b64; document.getElementById('preview-add').style.display = 'block'; document.getElementById('rotate-preview-add').style.display = 'flex'; } });
    document.getElementById('fix-image').addEventListener('change', async function() { if (this.files[0]) { const b64 = await convertBase64(this.files[0]); resetRotation('preview-fix'); document.getElementById('preview-fix').src = b64; document.getElementById('preview-fix').style.display = 'block'; document.getElementById('rotate-preview-fix').style.display = 'flex'; } });
    // ========== CAMERA FUNCTIONS ==========
let cameraStream = null;
let currentTargetInputId = null;
let capturedImageBlob = null;

// ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
async function openCamera(targetInputId) {
    currentTargetInputId = targetInputId;
    const modal = document.getElementById('camera-modal');
    const video = document.getElementById('camera-video');
    
    try {
        // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment', // ‡πÉ‡∏ä‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
        
        video.srcObject = cameraStream;
        modal.classList.add('active');
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        document.getElementById('camera-status-text').innerHTML = '<i class="fa-solid fa-camera mr-2"></i>‡∏à‡∏±‡∏î‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ';
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô
        document.getElementById('btn-capture').style.display = 'inline-block';
        document.getElementById('btn-retake').style.display = 'none';
        document.getElementById('btn-use-photo').style.display = 'none';
        
    } catch (error) {
        console.error('Camera Error:', error);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
    }
}

// ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
function capturePhoto() {
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    const ctx = canvas.getContext('2d');
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏•‡∏á‡∏ö‡∏ô canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Blob
    canvas.toBlob(function(blob) {
        capturedImageBlob = blob;
        
        // ‡πÅ‡∏™‡∏î‡∏á preview ‡∏ö‡∏ô canvas ‡πÅ‡∏ó‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
        video.style.display = 'none';
        canvas.style.display = 'block';
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        document.getElementById('camera-status-text').innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà';
        
        // ‡∏™‡∏•‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
        document.getElementById('btn-capture').style.display = 'none';
        document.getElementById('btn-retake').style.display = 'inline-block';
        document.getElementById('btn-use-photo').style.display = 'inline-block';
        
        // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
        }
    }, 'image/jpeg', 0.9);
}

// ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà
async function retakePhoto() {
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        });
        
        video.srcObject = cameraStream;
        video.style.display = 'block';
        canvas.style.display = 'none';
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        document.getElementById('camera-status-text').innerHTML = '<i class="fa-solid fa-camera mr-2"></i>‡∏à‡∏±‡∏î‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ';
        
        // ‡∏™‡∏•‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
        document.getElementById('btn-capture').style.display = 'inline-block';
        document.getElementById('btn-retake').style.display = 'none';
        document.getElementById('btn-use-photo').style.display = 'none';
        
        capturedImageBlob = null;
    } catch (error) {
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ');
    }
}

// ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢
function usePhoto() {
    if (!capturedImageBlob || !currentTargetInputId) return;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á FileList ‡∏à‡∏≥‡∏•‡∏≠‡∏á
    const file = new File([capturedImageBlob], `camera_${Date.now()}.jpg`, { type: 'image/jpeg' });
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    
    // ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤ input
    const targetInput = document.getElementById(currentTargetInputId);
    targetInput.files = dataTransfer.files;
    
    // Trigger change event ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á preview
    const event = new Event('change', { bubbles: true });
    targetInput.dispatchEvent(event);
    
    // ‡∏õ‡∏¥‡∏î modal
    closeCameraModal();
}

// ‡∏õ‡∏¥‡∏î Camera Modal
function closeCameraModal() {
    const modal = document.getElementById('camera-modal');
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    
    // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    // ‡∏ã‡πà‡∏≠‡∏ô modal
    modal.classList.remove('active');
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
    video.style.display = 'block';
    canvas.style.display = 'none';
    capturedImageBlob = null;
    currentTargetInputId = null;
}

// ‡∏õ‡∏¥‡∏î modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('camera-modal').classList.contains('active')) {
        closeCameraModal();
    }
});
    </script>
</body>
</html>
